@page "/Login"
@using Stockly.Services
@inject FirebaseService FirebaseService
@inject UserStateService UserState
@inject NavigationManager Navigation

<PageTitle>Login</PageTitle>

<div class="d-flex flex-column justify-center align-center" style="height: 80vh;">
    <div class="d-flex flex-column gap-3 pa-4" style="width: 300px;">
        <MudText Typo="Typo.h5" Class="text-center pb-4">Sign In</MudText>
        
        <MudForm @ref="form" @bind-IsValid="isValid" @bind-Errors="errors">
            <div class="d-flex align-center">
                <MudTextField @bind-Value="Username"
                             Label="Username"
                             Variant="Variant.Outlined"
                             Required="true"
                             RequiredError="Please enter your username"
                             Class="flex-grow-1"
                             Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Filled.Person" />
            </div>
            
            <div class="d-flex align-center">
                <MudTextField @bind-Value="Password"
                             Label="Password"
                             Variant="Variant.Outlined"
                             Required="true"
                             RequiredError="Please enter your password"
                             InputType="InputType.Password"
                             Class="flex-grow-1"
                             Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Filled.Lock" />
            </div>
            
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mt-2">@errorMessage</MudAlert>
            }
            
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      FullWidth="true"
                      Class="mt-4"
                      Size="Size.Medium"
                      OnClick="HandleSignIn"
                      Disabled="@isLoading">
                @if (isLoading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    <span class="ml-2">Signing In...</span>
                }
                else
                {
                    <span>Sign In</span>
                }
            </MudButton>
            

        </MudForm>
    </div>
</div>

@code {
    private string Username { get; set; }
    private string Password { get; set; }
    private string errorMessage = string.Empty;
    private MudForm form;
    private bool isValid;
    private string[] errors;
    private bool isLoading = false;
    
    private async Task HandleSignIn()
    {
        await form.Validate();
        
        if (!isValid)
        {
            errorMessage = "Please fill out all required fields";
            return;
        }
        
        errorMessage = string.Empty;
        isLoading = true;
        
        try
        {
            // Authenticate user with Firebase
            var user = await FirebaseService.AuthenticateUserAsync(Username, Password);
            
            if (user != null)
            {
                // Login successful
                UserState.Login(user);
                Navigation.NavigateTo("/");
            }
            else
            {
                // Login failed
                errorMessage = "Invalid username or password";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "An error occurred during sign in. Please try again.";
            Console.WriteLine($"Login error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }
    

}